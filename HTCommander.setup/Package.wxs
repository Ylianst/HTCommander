<?xml version="1.0" encoding="UTF-8"?>

<!-- 
  HTCommander WiX Installer
  This creates an MSI installer for the HTCommander application.
  
  To build:
    1. First build the main project: dotnet build ..\src\HTCommander.csproj -c Release
    2. Then build installer: dotnet build HTCommander.Installer.wixproj -c Release
  
  The MSI will be output to: bin\Release\HTCommander.msi
-->

<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

  <!-- Define variables for source directory -->
  <?define SourceDir = "..\src\bin\Release\net9.0-windows10.0.19041.0" ?>

  <Package Name="Handi-Talky Commander"
           Manufacturer="Open Source"
           Version="0.50.0"
           UpgradeCode="A0F710F7-510C-4231-82BA-D6A27CD75ECD"
           Compressed="yes"
           InstallerVersion="500"
           Scope="perMachine">

    <SummaryInformation Description="Handi-Talky Commander - Amateur Radio (HAM Radio) tool"
                        Keywords="Radio, HT, HAM, Amateur Radio"
                        Manufacturer="Open Source" />

    <!-- Upgrade handling - removes previous versions -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed."
                  AllowDowngrades="no"
                  AllowSameVersionUpgrades="yes" />

    <!-- Embed all files in the MSI -->
    <MediaTemplate EmbedCab="yes" CompressionLevel="high" />

    <!-- Define the icon for Add/Remove Programs -->
    <Icon Id="HTCommanderIcon" SourceFile="..\src\HTCommander.ico" />
    <Property Id="ARPPRODUCTICON" Value="HTCommanderIcon" />
    <Property Id="ARPHELPLINK" Value="https://github.com/Ylianst/HTCommander" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/Ylianst/HTCommander" />
    <Property Id="ARPCONTACT" Value="Ylian Saint-Hilaire" />
    <Property Id="ARPCOMMENTS" Value="Amateur Radio (HAM Radio) tool" />

    <!-- Feature definition -->
    <Feature Id="ProductFeature" Title="HTCommander" Level="1">
      <ComponentGroupRef Id="MainApplication" />
      <ComponentGroupRef Id="RuntimeFiles" />
      <ComponentGroupRef Id="WhisperRuntimeFiles" />
      <ComponentGroupRef Id="WinRuntimeFiles" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="DesktopShortcut" />
      <ComponentRef Id="WebFolderComponent" />
    </Feature>

    <!-- Use standard WiX UI -->
    <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
    
    <!-- Custom UI images -->
    <!-- DialogBmp: 493 x 312 pixels - shown on Welcome, Complete dialogs (left side) -->
    <WixVariable Id="WixUIDialogBmp" Value="DialogImage.bmp" />
    <!-- BannerBmp: 493 x 58 pixels - shown at top of other dialogs (optional) -->
    <!-- <WixVariable Id="WixUIBannerBmp" Value="BannerImage.bmp" /> -->

  </Package>

  <!-- Directory structure -->
  <Fragment>
    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="ManufacturerFolder" Name="Open Source">
        <Directory Id="INSTALLFOLDER" Name="HTCommander">
          <Directory Id="WebFolderDir" Name="web" />
          <Directory Id="RuntimesFolder" Name="runtimes">
            <Directory Id="WinX64Folder" Name="win-x64">
              <Directory Id="WinX64NativeFolder" Name="native" />
            </Directory>
            <Directory Id="WinFolder" Name="win">
              <Directory Id="WinLibFolder" Name="lib">
                <Directory Id="WinLibNet8Folder" Name="net8.0" />
              </Directory>
            </Directory>
          </Directory>
        </Directory>
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="Handi-Talky Commander" />
    </StandardDirectory>

    <StandardDirectory Id="DesktopFolder" />
  </Fragment>

  <!-- Main Application Files -->
  <Fragment>
    <ComponentGroup Id="MainApplication" Directory="INSTALLFOLDER">
      <!-- Main executable and config -->
      <Component Id="MainExe" Guid="*">
        <File Id="HTCommander.exe" Source="$(SourceDir)\HTCommander.exe" KeyPath="yes" />
      </Component>
      <Component Id="MainDll" Guid="*">
        <File Id="HTCommander.dll" Source="$(SourceDir)\HTCommander.dll" KeyPath="yes" />
      </Component>
      <Component Id="DepsJson" Guid="*">
        <File Id="HTCommander.deps.json" Source="$(SourceDir)\HTCommander.deps.json" KeyPath="yes" />
      </Component>
      <Component Id="RuntimeConfig" Guid="*">
        <File Id="HTCommander.runtimeconfig.json" Source="$(SourceDir)\HTCommander.runtimeconfig.json" KeyPath="yes" />
      </Component>
      
      <!-- Core dependencies -->
      <Component Id="NAudio" Guid="*">
        <File Id="NAudio.dll" Source="$(SourceDir)\NAudio.dll" KeyPath="yes" />
      </Component>
      <Component Id="NAudioCore" Guid="*">
        <File Id="NAudio.Core.dll" Source="$(SourceDir)\NAudio.Core.dll" KeyPath="yes" />
      </Component>
      <Component Id="NAudioAsio" Guid="*">
        <File Id="NAudio.Asio.dll" Source="$(SourceDir)\NAudio.Asio.dll" KeyPath="yes" />
      </Component>
      <Component Id="NAudioMidi" Guid="*">
        <File Id="NAudio.Midi.dll" Source="$(SourceDir)\NAudio.Midi.dll" KeyPath="yes" />
      </Component>
      <Component Id="NAudioWasapi" Guid="*">
        <File Id="NAudio.Wasapi.dll" Source="$(SourceDir)\NAudio.Wasapi.dll" KeyPath="yes" />
      </Component>
      <Component Id="NAudioWinForms" Guid="*">
        <File Id="NAudio.WinForms.dll" Source="$(SourceDir)\NAudio.WinForms.dll" KeyPath="yes" />
      </Component>
      <Component Id="NAudioWinMM" Guid="*">
        <File Id="NAudio.WinMM.dll" Source="$(SourceDir)\NAudio.WinMM.dll" KeyPath="yes" />
      </Component>
      <Component Id="GMapCore" Guid="*">
        <File Id="GMap.NET.Core.dll" Source="$(SourceDir)\GMap.NET.Core.dll" KeyPath="yes" />
      </Component>
      <Component Id="GMapWinForms" Guid="*">
        <File Id="GMap.NET.WindowsForms.dll" Source="$(SourceDir)\GMap.NET.WindowsForms.dll" KeyPath="yes" />
      </Component>
      <Component Id="Spectrogram" Guid="*">
        <File Id="Spectrogram.dll" Source="$(SourceDir)\Spectrogram.dll" KeyPath="yes" />
      </Component>
      <Component Id="FftSharp" Guid="*">
        <File Id="FftSharp.dll" Source="$(SourceDir)\FftSharp.dll" KeyPath="yes" />
      </Component>
      <Component Id="Whisper" Guid="*">
        <File Id="Whisper.net.dll" Source="$(SourceDir)\Whisper.net.dll" KeyPath="yes" />
      </Component>
      <Component Id="NewtonsoftJson" Guid="*">
        <File Id="Newtonsoft.Json.dll" Source="$(SourceDir)\Newtonsoft.Json.dll" KeyPath="yes" />
      </Component>
      <Component Id="EntityFramework" Guid="*">
        <File Id="EntityFramework.dll" Source="$(SourceDir)\EntityFramework.dll" KeyPath="yes" />
      </Component>
      <Component Id="EntityFrameworkSqlServer" Guid="*">
        <File Id="EntityFramework.SqlServer.dll" Source="$(SourceDir)\EntityFramework.SqlServer.dll" KeyPath="yes" />
      </Component>
      <Component Id="SystemDataSQLite" Guid="*">
        <File Id="System.Data.SQLite.dll" Source="$(SourceDir)\System.Data.SQLite.dll" KeyPath="yes" />
      </Component>
      <Component Id="SystemDataSQLiteEF6" Guid="*">
        <File Id="System.Data.SQLite.EF6.dll" Source="$(SourceDir)\System.Data.SQLite.EF6.dll" KeyPath="yes" />
      </Component>
      <Component Id="SystemSpeech" Guid="*">
        <File Id="System.Speech.dll" Source="$(SourceDir)\System.Speech.dll" KeyPath="yes" />
      </Component>
      <Component Id="SystemManagement" Guid="*">
        <File Id="System.Management.dll" Source="$(SourceDir)\System.Management.dll" KeyPath="yes" />
      </Component>
      <Component Id="SystemDataSqlClient" Guid="*">
        <File Id="System.Data.SqlClient.dll" Source="$(SourceDir)\System.Data.SqlClient.dll" KeyPath="yes" />
      </Component>
      <Component Id="WinRTRuntime" Guid="*">
        <File Id="WinRT.Runtime.dll" Source="$(SourceDir)\WinRT.Runtime.dll" KeyPath="yes" />
      </Component>
      <Component Id="MicrosoftWindowsSDK" Guid="*">
        <File Id="Microsoft.Windows.SDK.NET.dll" Source="$(SourceDir)\Microsoft.Windows.SDK.NET.dll" KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- Runtime files (native libraries) -->
  <Fragment>
    <ComponentGroup Id="RuntimeFiles" Directory="WinX64NativeFolder">
      <Component Id="SQLiteInterop" Guid="*">
        <File Id="SQLite.Interop.dll" Source="$(SourceDir)\runtimes\win-x64\native\SQLite.Interop.dll" KeyPath="yes" />
      </Component>
      <Component Id="SniDll" Guid="*">
        <File Id="sni.dll" Source="$(SourceDir)\runtimes\win-x64\native\sni.dll" KeyPath="yes" />
      </Component>
    </ComponentGroup>
    
    <!-- Whisper native DLLs (win-x64) -->
    <ComponentGroup Id="WhisperRuntimeFiles" Directory="WinX64Folder">
      <Component Id="WhisperDll" Guid="*">
        <File Id="whisper.dll" Source="$(SourceDir)\runtimes\win-x64\whisper.dll" KeyPath="yes" />
      </Component>
      <Component Id="GgmlBaseDll" Guid="*">
        <File Id="ggml_base_whisper.dll" Source="$(SourceDir)\runtimes\win-x64\ggml-base-whisper.dll" KeyPath="yes" />
      </Component>
      <Component Id="GgmlCpuDll" Guid="*">
        <File Id="ggml_cpu_whisper.dll" Source="$(SourceDir)\runtimes\win-x64\ggml-cpu-whisper.dll" KeyPath="yes" />
      </Component>
      <Component Id="GgmlWhisperDll" Guid="*">
        <File Id="ggml_whisper.dll" Source="$(SourceDir)\runtimes\win-x64\ggml-whisper.dll" KeyPath="yes" />
      </Component>
    </ComponentGroup>
    
    <!-- Windows runtime DLLs (runtimes\win\lib\net8.0) -->
    <ComponentGroup Id="WinRuntimeFiles" Directory="WinLibNet8Folder">
      <Component Id="WinSystemManagement" Guid="*">
        <File Id="Win_System.Management.dll" Source="$(SourceDir)\runtimes\win\lib\net8.0\System.Management.dll" KeyPath="yes" />
      </Component>
      <Component Id="WinSystemSpeech" Guid="*">
        <File Id="Win_System.Speech.dll" Source="$(SourceDir)\runtimes\win\lib\net8.0\System.Speech.dll" KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- Shortcuts -->
  <Fragment>
    <Component Id="ApplicationShortcut" Guid="*" Directory="ApplicationProgramsFolder">
      <Shortcut Id="ApplicationStartMenuShortcut"
                Name="Handi-Talky Commander"
                Description="Amateur Radio (HAM Radio) tool for controlling handheld transceivers"
                Target="[INSTALLFOLDER]HTCommander.exe"
                WorkingDirectory="INSTALLFOLDER"
                Icon="HTCommanderIcon" />
      <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\OpenSource\HTCommander" Name="installed" Type="integer" Value="1" KeyPath="yes" />
    </Component>

    <Component Id="DesktopShortcut" Guid="*" Directory="DesktopFolder">
      <Shortcut Id="DesktopShortcutId"
                Name="Handi-Talky Commander"
                Description="Amateur Radio (HAM Radio) tool for controlling handheld transceivers"
                Target="[INSTALLFOLDER]HTCommander.exe"
                WorkingDirectory="INSTALLFOLDER"
                Icon="HTCommanderIcon" />
      <RegistryValue Root="HKCU" Key="Software\OpenSource\HTCommander" Name="desktopshortcut" Type="integer" Value="1" KeyPath="yes" />
    </Component>

    <!-- Web folder component for web files -->
    <Component Id="WebFolderComponent" Guid="*" Directory="WebFolderDir">
      <File Id="WebIndexHtml" Source="..\src\Web\index.html" KeyPath="yes" />
    </Component>
  </Fragment>

</Wix>